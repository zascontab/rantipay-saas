FROM golang:1.20 AS builder

WORKDIR /app
COPY . .

# Compilar el servicio user
WORKDIR /app/user
RUN go mod download
RUN make build

FROM debian:stable-slim
RUN apt-get update && apt-get install -y --no-install-recommends \
        ca-certificates \
        netbase \
        curl \
        && rm -rf /var/lib/apt/lists/ \
        && apt-get autoremove -y && apt-get autoclean -y

WORKDIR /app

# Copiar el binario compilado y archivos necesarios
COPY --from=builder /app/user/bin/user /app/
COPY --from=builder /app/user/i18n /app/i18n

EXPOSE 8000
EXPOSE 9000

# Agregar un script para verificar la configuraci贸n y luego iniciar el servicio
COPY --from=builder /app/user/configs/config.yaml /app/default-config.yaml

# Agregar script de inicio
RUN echo '#!/bin/bash\n\
echo "Verificando configuraci贸n..."\n\
ls -la /data/conf\n\
if [ ! -f /data/conf/config.yaml ]; then\n\
  echo "Archivo de configuraci贸n no encontrado. Usando configuraci贸n por defecto..."\n\
  cp /app/default-config.yaml /data/conf/config.yaml\n\
fi\n\
echo "Iniciando servicio..."\n\
./user -conf /data/conf\n\
' > /app/start.sh && chmod +x /app/start.sh

VOLUME /data/conf
CMD ["/app/start.sh"]
